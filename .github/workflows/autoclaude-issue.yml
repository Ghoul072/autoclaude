# AutoClaude Issue Handler
# This workflow triggers when an issue is opened or when a user is mentioned in a comment
# Copy this file to your repository's .github/workflows/ directory

name: AutoClaude Issue Handler

on:
  issues:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  analyze-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Send event to AutoClaude
        env:
          AUTOCLAUDE_WEBHOOK_URL: ${{ secrets.AUTOCLAUDE_WEBHOOK_URL }}
          AUTOCLAUDE_WEBHOOK_SECRET: ${{ secrets.AUTOCLAUDE_WEBHOOK_SECRET }}
          GITHUB_EVENT_JSON: ${{ toJson(github.event) }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
        run: |
          # Write payload to file to avoid shell escaping issues
          echo "$GITHUB_EVENT_JSON" > /tmp/payload.json

          # Calculate signature from the file
          SIGNATURE="sha256=$(cat /tmp/payload.json | openssl dgst -sha256 -hmac "$AUTOCLAUDE_WEBHOOK_SECRET" | cut -d' ' -f2)"

          # Send the webhook
          curl -X POST "$AUTOCLAUDE_WEBHOOK_URL/webhook/github" \
            -H "Content-Type: application/json" \
            -H "X-GitHub-Event: $GITHUB_EVENT_NAME" \
            -H "X-Hub-Signature-256: $SIGNATURE" \
            --data-binary @/tmp/payload.json
